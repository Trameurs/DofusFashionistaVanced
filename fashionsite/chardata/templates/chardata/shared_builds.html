{% extends 'chardata/base.html' %}

{% load i18n %}
{% load static_s3 %}

{% block title %}The Dofus Fashionista: {% trans "Shared Builds" %}{% endblock %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{% static "chardata/forms.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static css_files.forms %}" class="forms-css css-file">
    <style>
        .shared-builds-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .filters-section {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 150px;
        }
        
        .filter-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #D4AF37;
        }
        
        .filter-input {
            padding: 8px;
            border: 1px solid #8B7355;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        
        .filter-input option {
            color: #333;
            background-color: white;
        }
        
        .builds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .build-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px solid #8B7355;
            border-radius: 8px;
            padding: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .build-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-color: #D4AF37;
        }
        
        .build-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .build-title {
            font-size: 18px;
            font-weight: bold;
            color: #D4AF37;
            margin: 0;
        }
        
        .build-char-name {
            font-size: 14px;
            color: #A0826D;
            margin: 5px 0;
        }
        
        .build-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin: 10px 0;
        }
        
        .build-info-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .build-label {
            font-weight: bold;
            color: #D4AF37;
        }
        
        .build-value {
            color: #555;
        }
        
        .build-stats {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
            padding-top: 10px;
            border-top: 1px solid #8B7355;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #D4AF37;
        }
        
        .stat-label {
            font-size: 12px;
            color: #A0826D;
        }
        
        .vote-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            padding-top: 10px;
            border-top: 1px solid #8B7355;
        }
        
        .vote-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 8px;
            border: 2px solid #8B7355;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.05);
            color: #D4AF37;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .vote-btn:hover {
            background-color: rgba(212, 175, 55, 0.1);
            border-color: #D4AF37;
        }
        
        .vote-btn.active {
            background-color: rgba(212, 175, 55, 0.2);
            border-color: #D4AF37;
            font-weight: bold;
        }
        
        .vote-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 30px 0;
        }
        
        .pagination a, .pagination span {
            padding: 8px 12px;
            border: 2px solid #8B7355;
            border-radius: 4px;
            color: #D4AF37;
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .pagination a:hover {
            background-color: rgba(212, 175, 55, 0.2);
            border-color: #D4AF37;
        }
        
        .pagination .current {
            background-color: #D4AF37;
            color: #000;
            font-weight: bold;
        }
        
        .pagination .disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .build-link {
            display: block;
            text-align: center;
            padding: 10px;
            background-color: #8B7355;
            color: #FFF !important;
            text-decoration: none !important;
            border-radius: 4px;
            margin-top: 10px;
            font-weight: bold;
            transition: background-color 0.2s, color 0.2s;
        }
        
        .build-link:hover {
            background-color: #D4AF37;
            color: #000 !important;
        }
        
        .build-link:visited {
            color: #FFF !important;
        }
        
        .build-link:visited:hover {
            color: #000 !important;
        }
        
        .no-builds {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #D0D0D0;
        }
        
        .filter-button {
            padding: 10px 20px;
            background-color: #8B7355;
            color: #FFF !important;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            text-decoration: none !important;
            transition: background-color 0.2s, color 0.2s;
        }
        
        .filter-button:hover {
            background-color: #D4AF37;
            color: #000 !important;
        }
        
        .filter-button:visited {
            color: #FFF !important;
        }
        
        .filter-button:visited:hover {
            color: #000 !important;
        }
        
        .results-count {
            font-size: 16px;
            color: #555;
            margin-bottom: 15px;
        }
        
        /* Text color for better visibility */
        .text {
            color: #555;
        }
        
        /* Build boxes styling (same as projdetails.html) */
        .build-boxes-section {
            border-collapse: collapse;
            border-spacing: 0;
        }
        
        .build-boxes-column {
            vertical-align: top;
            padding: 10px;
            border: 1px solid #8B7355;
        }
        
        .build-boxes-title {
            font-weight: bold;
            color: #D4AF37;
            text-align: center;
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .build-boxes-element-column,
        .build-boxes-options-column,
        .build-boxes-aspects-column {
            background-color: rgba(255, 255, 255, 0.02);
        }
        
        .build-boxes-section label {
            display: block;
            margin: 0;
            padding: 1px 0;
            color: #D4AF37;
            cursor: pointer;
            line-height: 1.2;
        }
        
        .build-boxes-section input[type="checkbox"] {
            margin-right: 5px;
            cursor: pointer;
            vertical-align: middle;
        }
        
        .build-boxes-section br {
            display: none;
        }
    </style>
{% endblock %}

{% block main %}
<div class="shared-builds-container">
    <h1 align="center">{% trans "Shared Builds" %}</h1>
    
    <p class="text" align="center">
        {% trans "Browse and discover builds shared by the community. Click on any build to view details." %}
    </p>
    
    <div class="filters-section">
        <h2>{% trans "Search & Filter" %}</h2>
        <form method="get" action="{% url 'shared_builds' %}">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">{% trans "Search" %}</label>
                    <input type="text" name="search" class="filter-input pretty-input" 
                           placeholder="{% trans 'Project or character name' %}" 
                           value="{{ filters.search }}">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">{% trans "User" %}</label>
                    <input type="text" name="user_search" class="filter-input pretty-input" 
                           placeholder="{% trans 'Search by username' %}" 
                           value="{{ filters.user_search }}">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">{% trans "Class" %}</label>
                    <select name="char_class" class="filter-input pretty-input">
                        <option value="">{% trans "All Classes" %}</option>
                        {% for class_name in all_classes %}
                            <option value="{{ class_name }}" {% if filters.char_class == class_name %}selected{% endif %}>
                                {{ class_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
            </div>
            
            <div class="filter-row" style="margin-top: 20px;">
                <div class="filter-group" style="width: 100%;">
                    <label class="filter-label">{% trans "Build Type" %}</label>
                    <table class="build-boxes-section" style="width: 100%; margin-top: 10px;">
                        <tr>
                            <td class="build-boxes-column build-boxes-title">{% trans "Elements" %}</td>
                            <td class="build-boxes-column build-boxes-title">{% trans "Options" %}</td>
                            <td class="build-boxes-column build-boxes-title" colspan="2">{% trans "Focus" %} <span style="color: #888; font-weight: normal;">({% trans "up to 2" %})</span></td>
                        </tr>
                        <tr>
                            <td id="filter-checkboxes-column-0" class="build-boxes-column build-boxes-element-column"></td>
                            <td id="filter-checkboxes-column-1" class="build-boxes-column build-boxes-options-column"></td>
                            <td id="filter-checkboxes-column-2" class="build-boxes-column build-boxes-aspects-column"></td>
                            <td id="filter-checkboxes-column-3" class="build-boxes-column build-boxes-aspects-column"></td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">{% trans "Min Level" %}</label>
                    <input type="number" name="min_level" class="filter-input pretty-input" 
                           placeholder="1" min="1" max="200" value="{{ filters.min_level }}">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">{% trans "Max Level" %}</label>
                    <input type="number" name="max_level" class="filter-input pretty-input" 
                           placeholder="200" min="1" max="200" value="{{ filters.max_level }}">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">{% trans "Order By" %}</label>
                    <select name="order_by" class="filter-input pretty-input">
                        <option value="created" {% if filters.order_by == 'created' or not filters.order_by %}selected{% endif %}>
                            {% trans "Recently Created" %}
                        </option>
                        <option value="modified" {% if filters.order_by == 'modified' %}selected{% endif %}>
                            {% trans "Recently Modified" %}
                        </option>
                        <option value="views" {% if filters.order_by == 'views' %}selected{% endif %}>
                            {% trans "Most Viewed" %}
                        </option>
                        <option value="likes" {% if filters.order_by == 'likes' %}selected{% endif %}>
                            {% trans "Most Liked" %}
                        </option>
                        <option value="favorites" {% if filters.order_by == 'favorites' %}selected{% endif %}>
                            {% trans "Most Favorited" %}
                        </option>
                    </select>
                </div>
            </div>
            
            {% if user.is_authenticated %}
            <div class="filter-row">
                <div class="filter-group">
                    <label style="color: #D4AF37;">
                        <input type="checkbox" name="show_liked" value="1" {% if filters.show_liked %}checked{% endif %}>
                        {% trans "Show only my liked builds" %}
                    </label>
                </div>
                <div class="filter-group">
                    <label style="color: #D4AF37;">
                        <input type="checkbox" name="show_favorited" value="1" {% if filters.show_favorited %}checked{% endif %}>
                        {% trans "Show only my favorited builds" %}
                    </label>
                </div>
            </div>
            {% endif %}
            
            <div class="filter-row" style="justify-content: center;">
                <button type="submit" class="filter-button button-generic">{% trans "Apply Filters" %}</button>
                <a href="{% url 'shared_builds' %}" class="filter-button button-generic" style="display: inline-block; text-decoration: none;">
                    {% trans "Clear Filters" %}
                </a>
            </div>
        </form>
    </div>
    
    {% if builds %}
        <div class="results-count">
            {% blocktrans count counter=page_obj.paginator.count %}Found {{ counter }} shared build{% plural %}Found {{ counter }} shared builds{% endblocktrans %}
            ({% trans "Page" %} {{ page_obj.number }} {% trans "of" %} {{ page_obj.paginator.num_pages }})
        </div>
        
        <div class="builds-grid">
            {% for build in builds %}
                <div class="build-card">
                    <div class="build-header">
                        <div>
                            <h3 class="build-title">{{ build.char.name }}</h3>
                            {% if build.char.char_name %}
                                <p class="build-char-name">{{ build.char.char_name }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="build-info">
                        {% if build.creator_name %}
                            <div class="build-info-row">
                                <span class="build-label">{% trans "Creator" %}:</span>
                                <span class="build-value">{{ build.creator_name }}</span>
                            </div>
                        {% endif %}
                        <div class="build-info-row">
                            <span class="build-label">{% trans "Class" %}:</span>
                            <span class="build-value">{{ build.char.char_class }}</span>
                        </div>
                        <div class="build-info-row">
                            <span class="build-label">{% trans "Level" %}:</span>
                            <span class="build-value">{{ build.char.level }}</span>
                        </div>
                        {% if build.build_name_translated %}
                            <div class="build-info-row">
                                <span class="build-label">{% trans "Build" %}:</span>
                                <span class="build-value">{{ build.build_name_translated }}</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="build-stats">
                        <div class="stat-item">
                            <div class="stat-value">{{ build.view_count }}</div>
                            <div class="stat-label">{% trans "Views" %}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="like-count-{{ build.char.id }}">{{ build.like_count }}</div>
                            <div class="stat-label">{% trans "Likes" %}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="favorite-count-{{ build.char.id }}">{{ build.favorite_count }}</div>
                            <div class="stat-label">{% trans "Favorites" %}</div>
                        </div>
                        {% if build.total_stats > 0 %}
                            <div class="stat-item">
                                <div class="stat-value">{{ build.total_stats|floatformat:0 }}</div>
                                <div class="stat-label">{% trans "Total Stats" %}</div>
                            </div>
                        {% endif %}
                    </div>
                    
                    {% if user.is_authenticated %}
                    <div class="vote-buttons">
                        <button class="vote-btn {% if build.user_liked %}active{% endif %}" 
                                onclick="vote({{ build.char.id }}, 'like', this)"
                                data-build-id="{{ build.char.id }}"
                                data-vote-type="like">
                            ❤️ {% trans "Like" %}
                        </button>
                        <button class="vote-btn {% if build.user_favorited %}active{% endif %}"
                                onclick="vote({{ build.char.id }}, 'favorite', this)"
                                data-build-id="{{ build.char.id }}"
                                data-vote-type="favorite">
                            ⭐ {% trans "Favorite" %}
                        </button>
                    </div>
                    {% endif %}
                    
                    <a href="{{ build.link }}" class="build-link" target="_blank">
                        {% trans "View Build" %} →
                    </a>
                </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">{% trans "First" %}</a>
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">{% trans "Previous" %}</a>
            {% else %}
                <span class="disabled">{% trans "First" %}</span>
                <span class="disabled">{% trans "Previous" %}</span>
            {% endif %}
            
            <span class="current">{% trans "Page" %} {{ page_obj.number }} {% trans "of" %} {{ page_obj.paginator.num_pages }}</span>
            
            {% if page_obj.has_next %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">{% trans "Next" %}</a>
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">{% trans "Last" %}</a>
            {% else %}
                <span class="disabled">{% trans "Next" %}</span>
                <span class="disabled">{% trans "Last" %}</span>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        <div class="no-builds">
            {% trans "No shared builds found matching your criteria. Try adjusting your filters." %}
        </div>
    {% endif %}
</div>

<script>
var aspectToName = {{ aspect_to_name|safe }};
var aspectLayout = {{ aspect_layout|safe }};
var selectedAspects = {{ selected_aspects|safe }};

function createCheckbox(aspect, label) {
    var isChecked = selectedAspects.indexOf(aspect) !== -1;
    var resultHtml = '<label><input type="checkbox" name="check_' + aspect + '" id="check_' + aspect + '" ' + (isChecked ? 'checked' : '') + '>' + label + '</label><br>';
    return $(resultHtml);
}

$(document).ready(function() {
    // Create checkboxes in columns
    $.each(aspectLayout, function(columnIndex, column) {
        $.each(column, function(i, aspect) {
            var box = createCheckbox(aspect, aspectToName[aspect]);
            $("#filter-checkboxes-column-" + columnIndex).append(box);
        });
    });
    
    // Setup Omni checkbox behavior
    var omniCheckbox = $("#check_omni");
    var elementCheckboxes = $("#check_str, #check_int, #check_cha, #check_agi");
    
    omniCheckbox.change(function() {
        if ($(this).prop('checked')) {
            // When Omni is checked, check all elements for visual feedback
            elementCheckboxes.prop('checked', true);
        } else {
            // When Omni is unchecked, uncheck all elements
            elementCheckboxes.prop('checked', false);
        }
    });
    
    elementCheckboxes.change(function() {
        // If any element is unchecked, uncheck Omni
        if (elementCheckboxes.filter(":checked").length < 4) {
            omniCheckbox.prop('checked', false);
        }
    });
    
    // Setup crit/noncrit mutual exclusion
    var checkboxCrit = $("#check_crit");
    var checkboxNoncrit = $("#check_noncrit");
    checkboxCrit.change(function() {
        if ($(this).prop('checked')) {
            checkboxNoncrit.prop('checked', false);
        }
    });
    checkboxNoncrit.change(function() {
        if ($(this).prop('checked')) {
            checkboxCrit.prop('checked', false);
        }
    });
    
    // Limit to 2 aspects from the Focus columns
    var aspectElements = $();
    $.each(aspectLayout[2].concat(aspectLayout[3]), function(i, aspect) {
        if (aspect != "balanced") {
            aspectElements = aspectElements.add("#check_" + aspect);
        }
    });
    
    var balancedElement = $("#check_balanced");
    
    balancedElement.change(function(e) {
        if ($(this).prop('checked')) {
            aspectElements.prop('checked', false);
        }
    });
    
    aspectElements.change(function() {
        if ($(this).prop('checked')) {
            balancedElement.prop('checked', false);
            // Limit to 2 selections
            if (aspectElements.filter(":checked").length > 2) {
                $(this).prop('checked', false);
                alert('{% trans "You can select up to 2 focus aspects only." %}');
            }
        }
    });
});

// Vote function
function vote(buildId, voteType, button) {
    var isActive = $(button).hasClass('active');
    var action = isActive ? 'remove' : 'add';
    
    // Disable button during request
    $(button).prop('disabled', true);
    
    $.ajax({
        url: '/votebuild/' + buildId + '/',
        type: 'POST',
        data: {
            'vote_type': voteType,
            'action': action,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                // Toggle active class
                $(button).toggleClass('active');
                
                // Update counts
                $('#like-count-' + buildId).text(response.like_count);
                $('#favorite-count-' + buildId).text(response.favorite_count);
            }
        },
        error: function(xhr) {
            alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
        },
        complete: function() {
            $(button).prop('disabled', false);
        }
    });
}
</script>
{% endblock %}
